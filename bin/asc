#!/usr/bin/env node
const usc = module.exports = require("./asc.js");

/** Add Cutomer Function to generate the abi. */
function reproduceDispath(sourceText, abi){

  let sb = new Array();
  if(abi.importElements){

    for(let sourceNode of abi.importElements.values()){
      sb.push(`import { ${sourceNode.importNames.join(',')} } from "./${sourceNode.sourceName}";`);
    }
  }

  // sourceText = sb.join(EOL) + EOL + sourceText;
  sourceText = sourceText.replace('export function apply(receiver: u64, code: u64, action: u64): void {}', abi.dispatch);

  return sourceText;
}

exports.reproduceDispath = reproduceDispath;


function resolveSourceText(sourceText, applyText, library){
	let memoryLib = "allocate/arena";
	let resultTextBuffer  = new Array();
	if(library[memoryLib] == undefined){
		resultTextBuffer.push( `import "allocator/arena";`);
	}

	resultTextBuffer.push(sourceText);

	if(applyText){
		resultTextBuffer.push(applyText);
	}
	return resultTextBuffer.join("\n");
}


module.exports.resolveSourceText = resolveSourceText;



if (/\busc$/.test(process.argv[1])) {
  const args = usc.parseArguments(process.argv.slice(2));

  // There are two steps to generate the wast file
  if(args.textFile){
  	usc.main(args);
  	process.exitCode = usc.main(args, null, null,true);
  } else {
  	process.exitCode = usc.main(args);
  }

}

